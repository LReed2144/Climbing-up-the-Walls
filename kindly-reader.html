<!-- Kindle-like Reader: anchor + non-scrolling pages, auto-fit -->
<section id="chapter-reader" style="scroll-margin-top: 96px; margin: 48px 0;">
    <div id="kindle-reader-root"
         data-file="{{ 'Climbing_up_the_Walls_Intro_Chapter.pdf' | file_url }}"
         data-title="Climbing up the Walls — Free Chapter"></div>
  </section>
  
  <script>
  (function(){
    var root = document.getElementById("kindle-reader-root");
    if (!root || root.dataset.init === "1") return;
    root.dataset.init = "1";
  
    // ===== Config =====
    var FILE_URL     = encodeURI(root.getAttribute("data-file") || "");
    var BOOK_TITLE   = root.getAttribute("data-title") || "Read a Free Chapter";
    var RENDER_SCALE = 4.0;
    var SPREAD_BREAK = 1000;
    var VIEWPORT_VH  = 88;
  
    var THEMES = {
      light: { bg:"#F8F7F4", paper:"#FFFFFF", text:"#111" },
      sepia: { bg:"#F3EAD9", paper:"#FBF3E2", text:"#2a241b" },
      dark:  { bg:"#0B0C10", paper:"#151821", text:"#e8ecf1" }
    };
    var DEFAULT_THEME = "sepia";
  
    // ===== CSS =====
    var css = `
      #chapter-reader{scroll-margin-top:96px;margin:48px 0;}
      .kr-wrap{--bg:${THEMES[DEFAULT_THEME].bg};--paper:${THEMES[DEFAULT_THEME].paper};--text:${THEMES[DEFAULT_THEME].text};}
      .kr-root{background:var(--bg); color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
               border-radius:12px; box-shadow:0 14px 40px rgba(0,0,0,.25); overflow:hidden}
      .kr-toolbar{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px;
                  border-bottom:1px solid rgba(0,0,0,.06); position:sticky; top:0; z-index:2;
                  background:linear-gradient(to bottom, rgba(255,255,255,.6), transparent)}
      .kr-title{font-size:15px; font-weight:600; opacity:.9; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
      .kr-controls{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
      .kr-btn,.kr-select{appearance:none; border:1px solid rgba(0,0,0,.12); background:rgba(255,255,255,.65);
                         padding:6px 10px; border-radius:8px; cursor:pointer; font-size:13px}
      .kr-btn:hover{background:rgba(255,255,255,.9)}
      .kr-btn[disabled]{opacity:.5; cursor:not-allowed}
      .kr-progress{appearance:none; width:160px; height:6px; border-radius:999px; overflow:hidden; background:rgba(0,0,0,.12)}
      .kr-progress::-webkit-progress-value{background:#7b9cff}
      .kr-stage{display:flex; justify-content:center; background:var(--bg)}
      .kr-sheet{position:relative; width:min(100%, 1200px); margin:12px; display:flex; justify-content:center; align-items:center}
      .kr-height{height:${VIEWPORT_VH}vh; width:100%; display:flex; gap:16px; justify-content:center; align-items:center}
      .kr-page{flex:1 1 0; max-width:calc(50% - 8px); background:var(--paper); border-radius:10px;
               box-shadow:0 18px 40px rgba(0,0,0,.22), 0 0 0 1px rgba(0,0,0,.06) inset;
               display:flex; align-items:center; justify-content:center; overflow:hidden}
      .kr-page.single{max-width:none}
      .kr-img{max-height:100%; max-width:100%; height:100%; width:auto; display:block; border-radius:6px;
              image-rendering:auto; opacity:0; transition:opacity .2s ease; object-fit:contain}
      .kr-zone{position:absolute; top:0; bottom:0; width:25%; cursor:pointer; opacity:0}
      .kr-zone.left{left:0} .kr-zone.right{right:0}
      .kr-dimmer-left,.kr-dimmer-right{pointer-events:none; position:absolute; top:0; bottom:0; width:12%; opacity:.20}
      .kr-dimmer-left{left:0; background:linear-gradient(to right, rgba(0,0,0,.08), transparent)}
      .kr-dimmer-right{right:0; background:linear-gradient(to left, rgba(0,0,0,.08), transparent)}
      @media (max-width:${SPREAD_BREAK-1}px){ .kr-page{max-width:none} .kr-zone{width:33%} }
    `;
    var styleEl = document.createElement("style"); styleEl.textContent = css; document.head.appendChild(styleEl);
  
    // ===== Build UI =====
    root.innerHTML = `
      <div class="kr-wrap">
        <div class="kr-root">
          <div class="kr-toolbar">
            <div class="kr-title" id="kr-title">${BOOK_TITLE}</div>
            <div class="kr-controls">
              <button class="kr-btn" id="kr-prev" aria-label="Previous">‹ Prev</button>
              <progress id="kr-progress" class="kr-progress" value="0" max="100"></progress>
              <span id="kr-counter" style="font-variant-numeric:tabular-nums;opacity:.8">0%</span>
              <button class="kr-btn" id="kr-next" aria-label="Next">Next ›</button>
              <select id="kr-theme" class="kr-select" title="Theme">
                <option value="light">Light</option>
                <option value="sepia" selected>Sepia</option>
                <option value="dark">Dark</option>
              </select>
              <button class="kr-btn" id="kr-full" title="Fullscreen">⤢</button>
            </div>
          </div>
          <div class="kr-stage">
            <div class="kr-sheet" id="kr-sheet">
              <div class="kr-height" id="kr-height">
                <div class="kr-page single" id="kr-left"><img id="kr-img-left" class="kr-img" alt=""></div>
                <div class="kr-page" id="kr-right"><img id="kr-img-right" class="kr-img" alt=""></div>
                <div class="kr-zone left"  id="kr-zone-left"></div>
                <div class="kr-zone right" id="kr-zone-right"></div>
                <div class="kr-dimmer-left"></div>
                <div class="kr-dimmer-right"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  
    // ===== Helpers =====
    function loadScript(src){return new Promise(function(res,rej){var s=document.createElement("script");s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);});}
    function setTheme(name){var t=THEMES[name]||THEMES.sepia;var w=document.querySelector(".kr-wrap");w.style.setProperty("--bg",t.bg);w.style.setProperty("--paper",t.paper);w.style.setProperty("--text",t.text);}
    function inSpread(){return window.matchMedia("(min-width:"+SPREAD_BREAK+"px)").matches;}
  
    // ===== Elements =====
    var leftImg  = document.getElementById("kr-img-left");
    var rightImg = document.getElementById("kr-img-right");
    var leftPage = document.getElementById("kr-left");
    var rightPage= document.getElementById("kr-right");
    var btnPrev  = document.getElementById("kr-prev");
    var btnNext  = document.getElementById("kr-next");
    var progress = document.getElementById("kr-progress");
    var counter  = document.getElementById("kr-counter");
    var zoneL    = document.getElementById("kr-zone-left");
    var zoneR    = document.getElementById("kr-zone-right");
    var themeSel = document.getElementById("kr-theme");
    var fullBtn  = document.getElementById("kr-full");
  
    // ===== State =====
    var images=[], total=0, index=0;
  
    // ===== PDF load/render =====
    async function renderPageToDataURL(pdf, pageNumber, scale){
      var page=await pdf.getPage(pageNumber);
      var viewport=page.getViewport({scale:scale});
      var canvas=document.createElement("canvas");
      var ctx=canvas.getContext("2d");
      canvas.width=viewport.width; canvas.height=viewport.height;
      await page.render({canvasContext:ctx, viewport:viewport}).promise;
      return {dataURL:canvas.toDataURL("image/jpeg",0.92), w:canvas.width, h:canvas.height};
    }
    async function loadPDF(){
      await loadScript("https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js");
      await loadScript("https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js");
      if (window.pdfjsLib){ window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js"; }
      var pdf=await window.pdfjsLib.getDocument({url:FILE_URL}).promise;
      total=pdf.numPages; images=new Array(total);
      for (var p=1;p<=total;p++){ counter.textContent="Loading "+p+"/"+total; images[p-1]=await renderPageToDataURL(pdf,p,RENDER_SCALE); progress.value=Math.round((p/total)*100); }
    }
  
    // ===== Render =====
    function render(){
      var leftIdx,rightIdx;
      if (inSpread()){
        if ((index+1)%2===1){ rightIdx=index; leftIdx=index-1; } else { leftIdx=index; rightIdx=index+1; }
        leftPage.style.display=leftIdx>=0?"flex":"none";
        rightPage.style.display=rightIdx<total?"flex":"none";
        leftPage.classList.remove("single"); rightPage.classList.remove("single");
      } else {
        leftIdx=index; rightIdx=-1;
        leftPage.style.display="flex"; rightPage.style.display="none"; leftPage.classList.add("single");
      }
      if (leftIdx>=0){ var L=images[leftIdx]; leftImg.style.opacity=0; leftImg.onload=function(){leftImg.style.opacity=1;}; leftImg.src=L.dataURL; leftImg.alt="Page "+(leftIdx+1); }
      if (rightIdx>=0&&rightIdx<total){ var R=images[rightIdx]; rightImg.style.opacity=0; rightImg.onload=function(){rightImg.style.opacity=1;}; rightImg.src=R.dataURL; rightImg.alt="Page "+(rightIdx+1); }
      var logical=Math.max(1,Math.min(total,index+1)), pct=Math.round((logical/total)*100);
      progress.value=pct; counter.textContent=pct+"%";
      btnPrev.disabled=(index<=0||(inSpread()&&index<=1));
      btnNext.disabled=(index>=total-1);
    }
  
    // ===== Navigation =====
    function goPrev(){ if(inSpread()){ index = index<=1?0:index-2; } else { index=Math.max(0,index-1); } render(); }
    function goNext(){ if(inSpread()){ index = index>=total-2?total-1:index+2; } else { index=Math.min(total-1,index+1); } render(); }
  
    // ===== Events =====
    btnPrev.addEventListener("click",goPrev);
    btnNext.addEventListener("click",goNext);
    zoneL.addEventListener("click",goPrev);
    zoneR.addEventListener("click",goNext);
    document.addEventListener("keydown",function(e){ if(e.key==="ArrowLeft")goPrev(); if(e.key==="ArrowRight")goNext(); });
    themeSel.addEventListener("change",function(){ var t=this.value; if(!THEMES[t]) t=DEFAULT_THEME; setTheme(t); });
    fullBtn.addEventListener("click",function(){ var el=root.querySelector(".kr-root"); if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen)?.call(el);} else {(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen)?.call(document);} });
    window.addEventListener("resize",render);
  
    // ===== Start =====
    (async function start(){
      try{ if(!FILE_URL){console.error("Missing PDF URL"); return;}
        setTheme(DEFAULT_THEME);
        await loadPDF(); index=0; render();
      }catch(err){ console.error(err); }
    })();
  })();
  </script>